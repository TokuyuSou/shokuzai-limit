<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é£ŸæãƒªãƒŸãƒƒãƒˆ | MVP</title>
  <style>
    :root{
      --bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--accent:#16a34a;--warn:#e11d48;
      --ring:#93c5fd;--chip:#e2e8f0
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(248,250,252,.9),rgba(248,250,252,.6));backdrop-filter:saturate(180%) blur(8px);z-index:5;border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0;display:flex;gap:12px;align-items:center}
    .badge{font-size:12px;background:var(--chip);padding:2px 8px;border-radius:999px;color:var(--muted)}
    main{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;padding:16px}
    @media (max-width:960px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #e5e7eb;font-size:18px}
    .section{padding:14px 16px}
    input,select,button,textarea{font:inherit}
    .field{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:10px}
    .field input,.field select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#111827;color:#fff;padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111827}
    .btn.ghost{background:transparent;border:1px solid #cbd5e1;color:#111827}
    .btn.warn{background:var(--warn)}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .inv-list{width:100%;border-collapse:separate;border-spacing:0 8px}
    .inv-list th{font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:0 8px}
    .row{display:grid;grid-template-columns:28px 1.3fr .6fr .8fr .7fr .6fr 100px;gap:8px;align-items:center;padding:8px;border:1px solid #e5e7eb;border-radius:12px}
    .row[data-soon="true"]{border-color:#fca5a5;background:#fff7f7}
    .chip{font-size:12px;background:var(--chip);padding:4px 8px;border-radius:999px}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .camera{display:grid;gap:8px}
    video,canvas{width:100%;border-radius:12px;border:1px dashed #cbd5e1;background:#f1f5f9}
    .steps{display:flex;flex-direction:column;gap:12px}
    .step{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .tts-controls{display:flex;gap:8px}
    .pill{padding:4px 8px;background:#ecfeff;border:1px solid #bae6fd;border-radius:999px;color:#0369a1;font-size:12px}
    .table-head{display:grid;grid-template-columns:28px 1.3fr .6fr .8fr .7fr .6fr 100px;gap:8px;padding:0 8px;margin-bottom:6px}
    .footer{padding:16px;color:var(--muted);text-align:center}
    .kbd{font-variant-ligatures: none; font-feature-settings: "liga" 0; border:1px solid #cbd5e1;padding:2px 6px;border-bottom-width:3px;border-radius:6px;background:#f8fafc}
    .danger{color:#b91c1c}
    .success{color:#065f46}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ³ é£ŸæãƒªãƒŸãƒƒãƒˆ <span class="badge">MVP</span></h1>
    </div>
  </header>
  <main class="wrap">
    <!-- å·¦ã‚«ãƒ©ãƒ ï¼šåœ¨åº«ç®¡ç† + ã‚¹ã‚­ãƒ£ãƒ³ -->
    <section class="card">
      <h2>åœ¨åº« & è¿½åŠ </h2>
      <div class="section">
        <form id="addForm">
          <div class="field"><label>é£Ÿæå</label><input id="name" placeholder="ä¾‹: ã«ã‚“ã˜ã‚“" required></div>
          <div class="field"><label>æ•°é‡</label><input id="qty" type="number" min="0" step="0.1" value="1" required></div>
          <div class="field"><label>å˜ä½</label>
            <select id="unit"><option>å€‹</option><option>g</option><option>ml</option><option>æŸ</option></select>
          </div>
          <div class="field"><label>è³å‘³(æ¶ˆè²»)æœŸé™</label><input id="expiry" type="date"></div>
          <div class="field"><label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="category"><option>é‡èœ</option><option>è‚‰ãƒ»é­š</option><option>ä¹³è£½å“</option><option>ç©€ç‰©</option><option>èª¿å‘³æ–™</option><option>ãã®ä»–</option></select>
          </div>
          <div class="stack">
            <button class="btn" type="submit">åœ¨åº«ã«è¿½åŠ </button>
            <button class="btn secondary" type="button" id="quickExp">+3æ—¥ã§è¨­å®š</button>
            <button class="btn ghost" type="button" id="clearForm">ã‚¯ãƒªã‚¢</button>
          </div>
        </form>
      </div>
      <div class="section">
        <h3 style="margin:0 0 8px">ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆæœŸé™OCRï¼‰</h3>
        <div class="camera">
          <video id="video" playsinline muted></video>
          <div class="stack">
            <button class="btn" id="startCam">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button class="btn secondary" id="snap">æ’®å½±â†’OCR</button>
            <span class="pill">å¯¾å¿œä¾‹: 2025/08/21, 25-08-21, 2025.08.21</span>
          </div>
          <canvas id="canvas" hidden></canvas>
          <div id="ocrOut" class="muted"></div>
        </div>
      </div>
      <div class="section">
        <h3 style="margin:0 0 6px">åœ¨åº«ä¸€è¦§ <span id="invCount" class="muted"></span></h3>
        <div class="table-head muted">
          <div>#</div><div>é£Ÿæ</div><div>æ•°é‡</div><div>æœŸé™</div><div>æ®‹ã‚Šæ—¥æ•°</div><div>ã‚«ãƒ†ã‚´ãƒª</div><div></div>
        </div>
        <div id="inventory"></div>
        <div class="stack" style="margin-top:10px">
          <button class="btn ghost" id="exportJson">åœ¨åº«ã‚’JSONã§ä¿å­˜</button>
          <input type="file" id="importJson" accept="application/json" style="display:none"/>
          <button class="btn ghost" id="importBtn">JSONã‹ã‚‰èª­ã¿è¾¼ã¿</button>
          <button class="btn warn right" id="wipe">å…¨å‰Šé™¤</button>
        </div>
      </div>
    </section>

    <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒ¬ã‚·ãƒ”ç”Ÿæˆ + éŸ³å£° + è²·ã„ç‰©ãƒªã‚¹ãƒˆ -->
    <section class="card">
      <h2>ãƒ¬ã‚·ãƒ”ææ¡ˆ & éŸ³å£°ã‚¬ã‚¤ãƒ‰</h2>
      <div class="section">
        <div class="stack" style="align-items:center">
          <label class="muted">å„ªå…ˆ: <span class="kbd">æœŸé™ãŒè¿‘ã„</span> / åˆ¶é™: <span class="kbd">~30åˆ†</span> / é›£æ˜“åº¦: <span class="kbd">ã‹ã‚“ãŸã‚“</span></label>
          <button class="btn" id="gen">ãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆ</button>
        </div>
      </div>
      <div class="section" id="recipeArea">
        <div class="muted">ã¾ã ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®åœ¨åº«ã‚’è¿½åŠ ã—ã¦ã€Œãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      <div class="section">
        <h3 style="margin:0 0 8px">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h3>
        <ul id="shopping"></ul>
        <div class="stack">
          <button class="btn ghost" id="copyShop">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn ghost" id="clearShop">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <div class="section">
        <details>
          <summary class="muted">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰</summary>
          <p>æ „é¤Šãƒãƒ©ãƒ³ã‚¹åˆ†æã¨å¥åº·ç®¡ç†ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆÂ¥500/æœˆï¼‰ã§æä¾›äºˆå®šã§ã™ã€‚</p>
        </details>
      </div>
    </section>
  </main>
  <div class="footer">MVP: ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ã€‚éŸ³å£°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®Web Speech APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</div>

  <!-- Tesseract.js CDN for OCR (run in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
  // ======= Storage & Utilities =======
  const storeKey = 'shokuzai.inv.v1';
  const $ = (q)=>document.querySelector(q);
  const $$=(q)=>Array.from(document.querySelectorAll(q));
  const fmtDate = (d)=> d? new Date(d).toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'}):'';
  const daysLeft = (d)=> {
    if(!d) return null; const target = new Date(d); target.setHours(23,59,59,999);
    const diff = target - new Date();
    return Math.ceil(diff/86400000);
  }
  function loadInv(){ try{return JSON.parse(localStorage.getItem(storeKey)||'[]')}catch(e){return []} }
  function saveInv(arr){ localStorage.setItem(storeKey, JSON.stringify(arr)); }

  // ======= Inventory UI =======
  function renderInv(){
    const inv = loadInv().sort((a,b)=>{
      const ad = a.expiry?new Date(a.expiry):new Date('2999-12-31');
      const bd = b.expiry?new Date(b.expiry):new Date('2999-12-31');
      return ad-bd;
    });
    $('#invCount').textContent = inv.length + ' ä»¶';
    const wrap = $('#inventory'); wrap.innerHTML='';
    inv.forEach((it, i)=>{
      const left = daysLeft(it.expiry);
      const soon = left!==null && left<=3;
      const row = document.createElement('div'); row.className='row'; row.dataset.soon = soon;
      row.innerHTML = `
        <div>${i+1}</div>
        <div>${it.name}</div>
        <div>${it.qty} ${it.unit||''}</div>
        <div>${it.expiry?fmtDate(it.expiry):'<span class="muted">â€”</span>'}</div>
        <div>${left===null?'<span class="muted">â€”</span>':left<0?'<span class="danger">æœŸé™åˆ‡ã‚Œ</span>':left+'æ—¥'}</div>
        <div><span class="chip">${it.category||'ãã®ä»–'}</span></div>
        <div class="stack">
          <button class="btn ghost" data-act="use" data-id="${it.id}">æ¶ˆè²»</button>
          <button class="btn ghost" data-act="del" data-id="${it.id}">å‰Šé™¤</button>
        </div>`;
      wrap.appendChild(row);
    });
  }

  function addInv(item){
    const inv = loadInv(); inv.push(item); saveInv(inv); renderInv();
  }
  function delInv(id){ const inv=loadInv().filter(x=>x.id!==id); saveInv(inv); renderInv(); }
  function useInv(id, amount=1){
    const inv = loadInv(); const idx = inv.findIndex(x=>x.id===id);
    if(idx>-1){ inv[idx].qty = Math.max(0, (parseFloat(inv[idx].qty)||0) - amount);
      if(inv[idx].qty===0) inv.splice(idx,1); saveInv(inv); renderInv(); }
  }

  // ======= Form Handlers =======
  $('#addForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const item = {
      id: crypto.randomUUID(),
      name: $('#name').value.trim(),
      qty: parseFloat($('#qty').value)||1,
      unit: $('#unit').value,
      expiry: $('#expiry').value || null,
      category: $('#category').value
    };
    if(!item.name){ alert('é£Ÿæåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    addInv(item); e.target.reset();
  });
  $('#clearForm').onclick=()=>$('#addForm').reset();
  $('#quickExp').onclick=()=>{
    const d = new Date(); d.setDate(d.getDate()+3);
    $('#expiry').value = d.toISOString().slice(0,10);
  }

  // Delegate buttons in inventory
  $('#inventory').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const act = btn.dataset.act;
    if(act==='del'){ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) delInv(id); }
    if(act==='use'){ useInv(id, 1); }
  });

  // Export/Import/Wipe
  $('#exportJson').onclick=()=>{
    const blob = new Blob([JSON.stringify(loadInv(),null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inventory.json'; a.click();
  }
  $('#importBtn').onclick=()=>$('#importJson').click();
  $('#importJson').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return; const text = await file.text();
    try { const data = JSON.parse(text); if(Array.isArray(data)){ saveInv(data); renderInv(); }
      else alert('ä¸æ­£ãªJSONã§ã™'); }
    catch(err){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  });
  $('#wipe').onclick=()=>{ if(confirm('åœ¨åº«ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(storeKey); renderInv(); } }

  // ======= Camera + OCR (Tesseract.js) =======
  let stream;
  async function startCamera(){
    if(stream) return; // already
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v = $('#video'); v.srcObject = stream; await v.play();
    }catch(err){ alert('ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“: '+err.message); }
  }
  $('#startCam').onclick = startCamera;

  // Simple date pattern extractor
  function extractDate(text){
    // Normalize
    const t = text.replace(/[\s\n]+/g,' ').replace(/[å¹´\.]/g,'/').replace(/-/g,'/');
    // Find yyyy/mm/dd or yy/mm/dd
    const m = t.match(/(20\d{2}|19\d{2}|\d{2})\/(0?[1-9]|1[0-2])\/(0?[1-9]|[12]\d|3[01])/);
    if(!m) return null;
    let [_, y, mo, da] = m;
    if(y.length===2){ y = (parseInt(y,10) > 50 ? '19'+y : '20'+y); }
    const mm = String(mo).padStart(2,'0');
    const dd = String(da).padStart(2,'0');
    return `${y}-${mm}-${dd}`;
  }

  $('#snap').onclick = async ()=>{
    try{
      if(!stream) await startCamera();
      const v=$('#video'); const c=$('#canvas'); c.hidden=false; c.width=v.videoWidth; c.height=v.videoHeight;
      const ctx=c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height);
      $('#ocrOut').textContent='OCRå‡¦ç†ä¸­â€¦';
      const { data } = await Tesseract.recognize(c.toDataURL('image/png'), 'jpn+eng');
      const raw = data.text || '';
      const iso = extractDate(raw);
      if(iso){ $('#expiry').value = iso; $('#ocrOut').innerHTML = `æ¤œå‡º: <b>${fmtDate(iso)}</b>`; }
      else { $('#ocrOut').innerHTML = `æ—¥ä»˜ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<span class="muted">ãƒ†ã‚­ã‚¹ãƒˆ: ${raw.slice(0,80)}â€¦</span>`; }
    }catch(err){
      console.error(err); alert('OCRã«å¤±æ•—: '+err.message);
    }
  }

  // ======= Recipe Generator (rule-based MVP) =======
  // Small recipe bank with required & optional ingredients
  const RECIPES = [
    { id:'yasai-soup', name:'ã‚„ã•ã—ã„é‡èœã‚¹ãƒ¼ãƒ—', time:20, level:'ã‹ã‚“ãŸã‚“',
      need:['ç‰ã­ã','ã«ã‚“ã˜ã‚“','ã˜ã‚ƒãŒã„ã‚‚','æ°´'], opt:['ã‚³ãƒ³ã‚½ãƒ¡','ãƒ™ãƒ¼ã‚³ãƒ³'],
      steps:[
        'é‡èœã‚’ä¸€å£å¤§ã«åˆ‡ã‚Šã¾ã™ã€‚',
        'é‹ã«æ²¹ã‚’ç†±ã—ã€ç‰ã­ãâ†’ã«ã‚“ã˜ã‚“â†’ã˜ã‚ƒãŒã„ã‚‚ã®é †ã«ç‚’ã‚ã¾ã™ã€‚',
        'æ°´ã¨ã‚³ãƒ³ã‚½ãƒ¡ã‚’å…¥ã‚Œã€ä¸­ç«ã§10ã€œ12åˆ†ç…®ã¾ã™ã€‚',
        'å¡©ã“ã—ã‚‡ã†ã§å‘³ã‚’æ•´ãˆã€å™¨ã«ã‚ˆãã„ã¾ã™ã€‚'
      ]
    },
    { id:'tamago-yakiudon', name:'ãŸã¾ã”ç„¼ã†ã©ã‚“', time:12, level:'ã‹ã‚“ãŸã‚“',
      need:['ã†ã©ã‚“','ãŸã¾ã”','ã­ã'], opt:['ã‚ã‚“ã¤ã‚†','é†¤æ²¹'],
      steps:[
        'ã†ã©ã‚“ã‚’è¡¨ç¤ºæ™‚é–“ã©ãŠã‚Šã«ä¸‹èŒ¹ã§ã—ã¾ã™ã€‚',
        'ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ã«æ²¹ã‚’ã²ãã€æº¶ãåµã‚’ç‚’ã‚ã€ã†ã©ã‚“ã¨ã­ãã‚’åŠ ãˆã¾ã™ã€‚',
        'ã‚ã‚“ã¤ã‚†ï¼ˆã¾ãŸã¯é†¤æ²¹ï¼‰ã§å‘³ã‚’æ•´ãˆã¦å®Œæˆã€‚'
      ]
    },
    { id:'curry', name:'ã‹ã‚“ãŸã‚“ã‚«ãƒ¬ãƒ¼', time:30, level:'ãµã¤ã†',
      need:['ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼','ç‰ã­ã','ã«ã‚“ã˜ã‚“','ã˜ã‚ƒãŒã„ã‚‚','æ°´'], opt:['è‚‰ãƒ»é­š'],
      steps:[
        'é‡èœã¨è‚‰ã‚’åˆ‡ã£ã¦ç‚’ã‚ã¾ã™ã€‚',
        'æ°´ã‚’åŠ ãˆã¦æŸ”ã‚‰ã‹ããªã‚‹ã¾ã§ç…®ã¾ã™ã€‚',
        'ç«ã‚’æ­¢ã‚ã¦ãƒ«ãƒ¼ã‚’æº¶ã‹ã—ã€å†åº¦ã¨ã‚ã¿ãŒå‡ºã‚‹ã¾ã§åŠ ç†±ã—ã¾ã™ã€‚'
      ]
    },
    { id:'yakisoba', name:'é‡èœãŸã£ã·ã‚Šç„¼ããã°', time:15, level:'ã‹ã‚“ãŸã‚“',
      need:['ç„¼ããã°éºº','ã‚­ãƒ£ãƒ™ãƒ„','ã«ã‚“ã˜ã‚“'], opt:['è±šè‚‰','ã‚½ãƒ¼ã‚¹'],
      steps:[
        'ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ã§éººã‚’è»½ãã»ãã—ã¾ã™ã€‚',
        'é‡èœã¨ï¼ˆã‚ã‚Œã°ï¼‰è±šè‚‰ã‚’åŠ ãˆã¦ç‚’ã‚ã¾ã™ã€‚',
        'ã‚½ãƒ¼ã‚¹ã§å‘³ä»˜ã‘ã—ã¦å®Œæˆã€‚'
      ]
    }
  ];

  function genRecipe(){
    const inv = loadInv();
    if(inv.length===0){ $('#recipeArea').innerHTML='<div class="muted">åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
    // pick top N near-expiry items
    const sorted = inv.slice().sort((a,b)=>{
      const ad=a.expiry?new Date(a.expiry):new Date('2999-12-31');
      const bd=b.expiry?new Date(b.expiry):new Date('2999-12-31');
      return ad-bd;
    });
    const focus = sorted.filter(x=>x.expiry).slice(0,4).map(x=>x.name);

    // score recipes by overlap with available items
    const names = inv.map(x=>x.name);
    let best = null; let bestScore=-1; let missing=[];
    for(const r of RECIPES){
      const haveNeed = r.need.filter(n=> names.some(m=> m.includes(n)) );
      const score = haveNeed.length - r.need.length*0.1 + r.opt.filter(o=> names.some(m=>m.includes(o)) ).length*0.05;
      if(score>bestScore){ best=r; bestScore=score; }
    }
    // compute missing for best
    missing = best.need.filter(n=> !names.some(m=>m.includes(n)) );

    const eta = `â±ï¸ ç´„${best.time}åˆ†`; const lvl = `ğŸ¯ ${best.level}`;
    const near = focus.length? `å„ªå…ˆé£Ÿæ: ${focus.map(x=>`<span class="pill">${x}</span>`).join(' ')}`: '';

    $('#recipeArea').innerHTML = `
      <div class="stack" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">${best.name}</h3>
        <div class="muted">${eta} ãƒ» ${lvl}</div>
      </div>
      <div class="muted" style="margin-bottom:8px">${near}</div>
      <div><b>å¿…è¦ãªé£Ÿæ:</b> ${best.need.join('ã€')}</div>
      <div class="muted" style="margin:6px 0"><b>ã‚ã‚‹ã¨è‰¯ã„:</b> ${best.opt.join('ã€')}</div>
      <div class="steps" id="steps">
        ${best.steps.map((s,i)=>`<div class="step" data-idx="${i}"><b>æ‰‹é † ${i+1}.</b> ${s}</div>`).join('')}
      </div>
      <div class="tts-controls" style="margin-top:8px">
        <button class="btn" id="ttsPlay">â–¶ï¸ èª­ã¿ä¸Šã’</button>
        <button class="btn secondary" id="ttsPause">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
        <button class="btn secondary" id="ttsResume">â¯ï¸ å†é–‹</button>
        <button class="btn ghost" id="finishCook">ğŸ½ï¸ ä½œã£ãŸï¼</button>
      </div>
    `;

    // TTS handlers
    const utterances = best.steps.map((text,i)=>{
      const u = new SpeechSynthesisUtterance(`æ‰‹é † ${i+1}ã€‚${text}`);
      u.lang='ja-JP';
      u.rate=1.0; u.pitch=1.0; return u;
    });

    $('#ttsPlay').onclick = ()=>{
      speechSynthesis.cancel(); // reset
      utterances.forEach((u, i)=>{
        u.onstart=()=> highlightStep(i,true);
        u.onend=()=> highlightStep(i,false);
        speechSynthesis.speak(u);
      })
    }
    $('#ttsPause').onclick = ()=> speechSynthesis.pause();
    $('#ttsResume').onclick = ()=> speechSynthesis.resume();

    // Finish cooking: decrement used ingredients by 1 (rough MVP)
    $('#finishCook').onclick = ()=>{
      const namesToUse = best.need; // simplify
      const invNow = loadInv();
      namesToUse.forEach(n=>{
        const hit = invNow.find(x=> x.name.includes(n));
        if(hit){ hit.qty = Math.max(0,(parseFloat(hit.qty)||0)-1); }
      });
      const remaining = invNow.filter(x=> (parseFloat(x.qty)||0)>0);
      saveInv(remaining); renderInv();
      // Build shopping list for missing
      const missingNow = best.need.filter(n=> !remaining.some(m=> m.name.includes(n)) );
      setShopping(missing.concat(missingNow));
      alert('åœ¨åº«ã‚’æ›´æ–°ã—ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
    }
  }

  function highlightStep(i, on){
    const el = document.querySelector(`#steps .step[data-idx="${i}"]`); if(!el) return;
    el.style.borderColor = on? '#93c5fd':'#e5e7eb';
    el.style.boxShadow = on? '0 0 0 3px rgba(147,197,253,.3)':'none';
  }

  document.querySelector('#gen').onclick = genRecipe;

  // ======= Shopping List =======
  function setShopping(items){
    const list = document.querySelector('#shopping'); list.innerHTML='';
    const uniq = Array.from(new Set(items));
    uniq.forEach(x=>{ const li=document.createElement('li'); li.textContent=x; list.appendChild(li); });
  }
  document.querySelector('#copyShop').onclick=()=>{
    const text = Array.from(document.querySelectorAll('#shopping li')).map(li=>`- ${li.textContent}`).join('\n');
    navigator.clipboard.writeText(text||'').then(()=>{
      alert('è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    });
  }
  document.querySelector('#clearShop').onclick=()=>{ document.querySelector('#shopping').innerHTML=''; }

  // ======= Init =======
  renderInv();
  </script>
</body>
</html>
